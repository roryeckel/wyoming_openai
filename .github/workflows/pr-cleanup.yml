name: PR Docker Cleanup

on:
  pull_request:
    types: [closed]
    branches: [ "main" ]

jobs:
  cleanup:
    # Only run for PRs from the same repository (security measure)
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete PR Docker image
      continue-on-error: true
      run: |
        # Convert repository name to lowercase for Docker registry
        REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        PACKAGE_NAME=$(basename ${REPO_LOWER})
        TAG_NAME="pr-${{ github.event.number }}"
        
        echo "Attempting to delete tag: ${TAG_NAME} for package: ${PACKAGE_NAME}"
        
        # Get all versions of the package
        VERSIONS=$(curl -s \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/user/packages/container/${PACKAGE_NAME}/versions" \
          | jq -r '.[] | select(.metadata.container.tags[]? == "'${TAG_NAME}'") | .id')
        
        if [ -n "$VERSIONS" ]; then
          for VERSION_ID in $VERSIONS; do
            echo "Deleting version ID: $VERSION_ID with tag: ${TAG_NAME}"
            curl -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/user/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}"
            echo "Successfully deleted Docker image version: ${VERSION_ID}"
          done
        else
          echo "No Docker image found for tag: ${TAG_NAME}, nothing to clean up"
        fi